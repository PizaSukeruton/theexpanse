<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q&A Extractor - The Expanse</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #00ff00;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
            text-shadow: 0 0 10px #00ff00;
        }
        
        .step {
            background: #111;
            border: 2px solid #00ff00;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 10px;
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .step-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #00ffff;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        input[type="file"],
        input[type="text"],
        input[type="number"] {
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px;
            width: 100%;
            font-family: 'Courier New', monospace;
        }
        
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            border-radius: 5px;
            transition: all 0.3s;
            margin-right: 10px;
        }
        
        button:hover {
            background: #00cc00;
            box-shadow: 0 0 20px #00ff00;
        }
        
        button:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .page-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #333;
        }
        
        .page-card {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .page-card:hover {
            border-color: #00ff00;
        }
        
        .page-card.selected {
            background: #003300;
            border-color: #00ff00;
        }
        
        .page-number {
            font-size: 1.2em;
            color: #00ff00;
        }
        
        .page-words {
            font-size: 0.8em;
            color: #666;
        }
        
        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #333;
        }
        
        .topic-card {
            background: #000;
            border: 1px solid #333;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .topic-card:hover {
            border-color: #00ff00;
        }
        
        .topic-card.selected {
            background: #003300;
            border-color: #00ff00;
        }
        
        .topic-name {
            font-size: 1.1em;
            color: #00ff00;
            margin-bottom: 5px;
        }
        
        .topic-count {
            font-size: 0.9em;
            color: #ffff00;
        }
        
        .qa-card {
            background: #111;
            border: 1px solid #00ff00;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        
        .qa-card.approved {
            border-color: #00ff00;
            background: #002200;
        }
        
        .qa-card.rejected {
            border-color: #ff0000;
            background: #220000;
            opacity: 0.5;
        }
        
        .qa-question {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: #00ffff;
        }
        
        .qa-answer-short {
            margin-bottom: 10px;
            color: #ffff00;
        }
        
        .qa-answer-full {
            margin-bottom: 10px;
            color: #00ff00;
        }
        
        .qa-evidence {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
            margin-bottom: 15px;
        }
        
        .qa-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-approve {
            background: #00ff00;
            color: #000;
            padding: 8px 15px;
            border: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
        }
        
        .btn-reject {
            background: #ff0000;
            color: #fff;
            padding: 8px 15px;
            border: none;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            border-radius: 3px;
        }
        
        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        
        .status.processing {
            background: #222;
            border: 2px solid #ffff00;
            color: #ffff00;
            display: block;
        }
        
        .status.success {
            background: #002200;
            border: 2px solid #00ff00;
            display: block;
        }
        
        .status.error {
            background: #220000;
            border: 2px solid #ff0000;
            color: #ff0000;
            display: block;
        }
        
        .quick-select {
            margin: 10px 0;
        }
        
        .quick-select button {
            font-size: 0.9em;
            padding: 8px 15px;
            margin-right: 10px;
        }
        
        .summary {
            background: #111;
            border: 2px solid #00ff00;
            padding: 20px;
            margin-top: 30px;
            border-radius: 5px;
        }
        
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            color: #00ff00;
        }
        
        .stat-label {
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ¤– Q&A EXTRACTOR - 3-STEP PROCESS</h1>
        
        <div id="step1" class="step active">
            <div class="step-header">STEP 1: Upload PDF & Select Pages</div>
            
            <div class="form-group">
                <label for="pdfFile">ðŸ“„ Select PDF Document:</label>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>
            
            <button onclick="analyzePDF()">ANALYZE PDF</button>
            
            <div id="status1" class="status"></div>
            
            <div id="pageSelection" style="display:none; margin-top: 30px;">
                <h3>Select Pages to Process:</h3>
                
                <div class="quick-select">
                    <button onclick="selectAllPages()">SELECT ALL</button>
                    <button onclick="selectNone()">SELECT NONE</button>
                    <button onclick="selectRange()">SELECT RANGE</button>
                </div>
                
                <div class="form-group">
                    <label>Or enter custom selection (e.g., "1-10, 15, 20-25"):</label>
                    <input type="text" id="customPages" placeholder="1-10, 15, 20-25">
                </div>
                
                <div id="pageGrid" class="page-grid"></div>
                
                <button onclick="proceedToTopics()">PROCEED TO TOPIC SELECTION</button>
            </div>
        </div>
        
        <div id="step2" class="step">
            <div class="step-header">STEP 2: Select Topics for Q&A Generation</div>
            
            <div id="status2" class="status"></div>
            
            <div id="topicSelection">
                <h3>Select Topics (most frequent entities):</h3>
                
                <div class="quick-select">
                    <button onclick="selectAllTopics()">SELECT ALL</button>
                    <button onclick="selectNoneTopics()">SELECT NONE</button>
                    <button onclick="selectTop(10)">SELECT TOP 10</button>
                    <button onclick="selectTop(25)">SELECT TOP 25</button>
                </div>
                
                <div id="topicGrid" class="topic-grid"></div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <label for="qaLimit">ðŸ”¢ Number of Q&A Pairs to Generate:</label>
                    <input type="number" id="qaLimit" value="25" min="1" max="100">
                </div>
                
                <button onclick="generateQA()">GENERATE Q&A PAIRS</button>
                <button onclick="backToStep1()" style="background: #666;">BACK TO PAGES</button>
            </div>
        </div>
        
        <div id="step3" class="step">
            <div class="step-header">STEP 3: Review & Approve Q&A Pairs</div>
            
            <div id="status3" class="status"></div>
            
            <div id="qaResults"></div>
            
            <div id="summary" class="summary" style="display:none;">
                <div class="summary-stats">
                    <div class="stat">
                        <div class="stat-number" id="approvedCount">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat">
                        <div class="stat-number" id="rejectedCount">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
                <button onclick="submitApproved()" style="display: block; margin: 0 auto;">SUBMIT APPROVED Q&A PAIRS</button>
                <button onclick="backToStep2()" style="background: #666; display: block; margin: 10px auto 0;">BACK TO TOPICS</button>
            </div>
        </div>
    </div>
    
    <script>
        let pdfData = null;
        let selectedPages = new Set();
        let topicData = null;
        let selectedTopics = new Set();
        let qaData = [];
        let approvedSet = new Set();
        let rejectedSet = new Set();
        
        async function analyzePDF() {
            const fileInput = document.getElementById('pdfFile');
            const statusDiv = document.getElementById('status1');
            
            if (!fileInput.files[0]) {
                alert('Please select a PDF file');
                return;
            }
            
            const formData = new FormData();
            formData.append('pdf', fileInput.files[0]);
            
            statusDiv.className = 'status processing';
            statusDiv.textContent = 'â³ Analyzing PDF...';
            
            try {
                const response = await fetch('/api/qa/analyze', {
                    method: 'POST',
                    body: formData
                });
                
                pdfData = await response.json();
                
                if (pdfData.status === 'success') {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `âœ… PDF analyzed: ${pdfData.total_pages} pages found`;
                    displayPages();
                } else {
                    throw new Error(pdfData.error || 'Analysis failed');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ Error: ${error.message}`;
            }
        }
        
        function displayPages() {
            const pageGrid = document.getElementById('pageGrid');
            const pageSelection = document.getElementById('pageSelection');
            
            pageGrid.innerHTML = '';
            selectedPages.clear();
            
            pdfData.pages.forEach(page => {
                const card = document.createElement('div');
                card.className = 'page-card';
                card.onclick = () => togglePage(page.page_number, card);
                
                card.innerHTML = `
                    <div class="page-number">Page ${page.page_number}</div>
                    <div class="page-words">${page.word_count} words</div>
                `;
                
                pageGrid.appendChild(card);
            });
            
            pageSelection.style.display = 'block';
        }
        
        function togglePage(pageNum, card) {
            if (selectedPages.has(pageNum)) {
                selectedPages.delete(pageNum);
                card.classList.remove('selected');
            } else {
                selectedPages.add(pageNum);
                card.classList.add('selected');
            }
        }
        
        function selectAllPages() {
            const cards = document.querySelectorAll('.page-card');
            cards.forEach((card, index) => {
                const pageNum = index + 1;
                selectedPages.add(pageNum);
                card.classList.add('selected');
            });
        }
        
        function selectNone() {
            selectedPages.clear();
            document.querySelectorAll('.page-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        
        function selectRange() {
            const range = prompt('Enter page range (e.g., "1-10" or "1-10, 15, 20-25"):');
            if (!range) return;
            
            document.getElementById('customPages').value = range;
        }
        
        async function proceedToTopics() {
            const statusDiv = document.getElementById('status2');
            
            let pageSelection = 'all';
            
            const customPages = document.getElementById('customPages').value;
            if (customPages.trim()) {
                pageSelection = customPages.trim();
            } else if (selectedPages.size > 0 && selectedPages.size < pdfData.total_pages) {
                pageSelection = Array.from(selectedPages).sort((a,b) => a-b).join(',');
            }
            
            statusDiv.className = 'status processing';
            statusDiv.textContent = 'â³ Extracting topics from selected pages...';
            
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            
            try {
                const response = await fetch('/api/qa/extract-topics', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pdf_path: pdfData.pdf_path,
                        page_selection: pageSelection
                    })
                });
                
                topicData = await response.json();
                
                if (topicData.status === 'success') {
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `âœ… Found ${topicData.topics.length} topics from ${topicData.pages_processed.length} pages`;
                    displayTopics();
                } else {
                    throw new Error(topicData.error || 'Topic extraction failed');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ Error: ${error.message}`;
            }
        }
        
        function displayTopics() {
            const topicGrid = document.getElementById('topicGrid');
            
            topicGrid.innerHTML = '';
            selectedTopics.clear();
            
            topicData.topics.forEach((topic, index) => {
                const card = document.createElement('div');
                card.className = 'topic-card';
                card.onclick = () => toggleTopic(topic.topic, card);
                
                card.innerHTML = `
                    <div class="topic-name">${topic.topic}</div>
                    <div class="topic-count">${topic.count} mentions</div>
                `;
                
                topicGrid.appendChild(card);
            });
        }
        
        function toggleTopic(topicName, card) {
            if (selectedTopics.has(topicName)) {
                selectedTopics.delete(topicName);
                card.classList.remove('selected');
            } else {
                selectedTopics.add(topicName);
                card.classList.add('selected');
            }
        }
        
        function selectAllTopics() {
            const cards = document.querySelectorAll('.topic-card');
            topicData.topics.forEach((topic, index) => {
                selectedTopics.add(topic.topic);
                cards[index].classList.add('selected');
            });
        }
        
        function selectNoneTopics() {
            selectedTopics.clear();
            document.querySelectorAll('.topic-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        
        function selectTop(n) {
            selectNoneTopics();
            const cards = document.querySelectorAll('.topic-card');
            topicData.topics.slice(0, n).forEach((topic, index) => {
                selectedTopics.add(topic.topic);
                cards[index].classList.add('selected');
            });
        }
        
        async function generateQA() {
            if (selectedTopics.size === 0) {
                alert('Please select at least one topic');
                return;
            }
            
            const statusDiv = document.getElementById('status3');
            const limit = document.getElementById('qaLimit').value;
            
            statusDiv.className = 'status processing';
            statusDiv.textContent = 'â³ Generating Q&A pairs focused on selected topics...';
            
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
            
            const customPages = document.getElementById('customPages').value;
            let pageSelection = 'all';
            if (customPages.trim()) {
                pageSelection = customPages.trim();
            } else if (selectedPages.size > 0 && selectedPages.size < pdfData.total_pages) {
                pageSelection = Array.from(selectedPages).sort((a,b) => a-b).join(',');
            }
            
            try {
                const response = await fetch('/api/qa/extract-qa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pdf_path: pdfData.pdf_path,
                        selected_topics: Array.from(selectedTopics),
                        page_selection: pageSelection,
                        limit: parseInt(limit)
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    qaData = result.qa_pairs;
                    statusDiv.className = 'status success';
                    statusDiv.textContent = `âœ… Generated ${result.total_extracted} Q&A pairs`;
                    displayQAResults();
                } else {
                    throw new Error(result.error || 'Q&A generation failed');
                }
            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `âŒ Error: ${error.message}`;
            }
        }
        
        function displayQAResults() {
            const resultsDiv = document.getElementById('qaResults');
            const summaryDiv = document.getElementById('summary');
            
            resultsDiv.innerHTML = '';
            approvedSet.clear();
            rejectedSet.clear();
            
            qaData.forEach((qa, index) => {
                const card = document.createElement('div');
                card.className = 'qa-card';
                card.id = `qa-${index}`;
                
                card.innerHTML = `
                    <div class="qa-question"><strong>Q:</strong> ${qa.question}</div>
                    <div class="qa-answer-short"><strong>Short Answer:</strong> ${qa.answer_short}</div>
                    <div class="qa-answer-full"><strong>Full Answer:</strong> ${qa.answer_sentence}</div>
                    <div class="qa-evidence"><strong>Evidence:</strong> "${qa.evidence_span}"</div>
                    <div class="qa-actions">
                        <button class="btn-approve" onclick="approveQA(${index})">âœ“ APPROVE</button>
                        <button class="btn-reject" onclick="rejectQA(${index})">âœ— REJECT</button>
                    </div>
                `;
                
                resultsDiv.appendChild(card);
            });
            
            summaryDiv.style.display = 'block';
            updateStats();
        }
        
        function approveQA(index) {
            approvedSet.add(index);
            rejectedSet.delete(index);
            document.getElementById(`qa-${index}`).className = 'qa-card approved';
            updateStats();
        }
        
        function rejectQA(index) {
            rejectedSet.add(index);
            approvedSet.delete(index);
            document.getElementById(`qa-${index}`).className = 'qa-card rejected';
            updateStats();
        }
        
        function updateStats() {
            document.getElementById('approvedCount').textContent = approvedSet.size;
            document.getElementById('rejectedCount').textContent = rejectedSet.size;
        }
        
        function backToStep1() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
        }
        
        function backToStep2() {
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.add('active');
        }
        
        function submitApproved() {
            const approved = Array.from(approvedSet).map(i => qaData[i]);
            
            if (approved.length === 0) {
                alert('Please approve at least one Q&A pair');
                return;
            }
            
            console.log('Approved Q&A pairs:', approved);
            alert(`Ready to submit ${approved.length} approved Q&A pairs to AOK database.\n\nNext step: Create AOK category and insert entries.`);
        }
    </script>
</body>
</html>
