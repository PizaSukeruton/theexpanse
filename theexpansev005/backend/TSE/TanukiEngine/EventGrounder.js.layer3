import pool from "../../db/pool.js";

/**
 * EventGrounder - Layer 3: Query Claude's experienced events
 * 
 * When Claude is asked "What have you been through?" or "Have you witnessed the Cheese Wars?"
 * this class queries his actual event history to ground the response in lived experience.
 */
export default class EventGrounder {
  constructor() {
    this.CLAUDE_CHARACTER_ID = "#700002"; // Fixed: Claude's hex ID
  }

  /**
   * Main entry point: Ground a response in Claude's event history
   * @param {string} entity - Event type or location to find (e.g., "cheese wars", "realm")
   * @param {string} characterId - Character asking (usually "#700002" for Claude)
   * @returns {object} Grounded events context
   */
  async ground(entity, characterId = this.CLAUDE_CHARACTER_ID) {
    try {
      // Query all four event types in parallel
      const [multiverseEvents, omiyageEvents, psychicEvents, levelHistory] = await Promise.all([
        this.queryMultiverseEvents(characterId),
        this.queryOmiyageEvents(characterId),
        this.queryPsychicEvents(characterId),
        this.queryLevelHistory(characterId)
      ]);

      // Find matches for the entity
      const relatedEvents = this.matchEvents(entity, multiverseEvents, omiyageEvents, psychicEvents);

      return {
        entity,
        characterId,
        timestamp: new Date().toISOString(),
        multiverseEvents: multiverseEvents,
        omiyageEvents: omiyageEvents,
        psychicEvents: psychicEvents,
        levelHistory: levelHistory,
        groundedEvents: {
          hasMultiverseMatch: relatedEvents.multiverse.length > 0,
          hasOmiyageMatch: relatedEvents.omiyage.length > 0,
          hasPsychicMatch: relatedEvents.psychic.length > 0,
          relatedMultiverse: relatedEvents.multiverse,
          relatedOmiyage: relatedEvents.omiyage,
          relatedPsychic: relatedEvents.psychic
        },
        matchConfidence: Math.max(
          relatedEvents.multiverse.length > 0 ? 0.9 : 0,
          relatedEvents.omiyage.length > 0 ? 0.8 : 0,
          relatedEvents.psychic.length > 0 ? 0.7 : 0
        )
      };
    } catch (err) {
      console.error("EventGrounder.ground() error:", err.message);
      return {
        entity,
        characterId,
        timestamp: new Date().toISOString(),
        error: err.message,
        groundedEvents: null,
        multiverseEvents: [],
        omiyageEvents: [],
        psychicEvents: [],
        levelHistory: []
      };
    }
  }

  /**
   * Query multiverse events involving Claude
   * @param {string} characterId 
   * @returns {array} Array of multiverse events
   */
  async queryMultiverseEvents(characterId) {
    try {
      const query = `
        SELECT 
          event_id,
          timestamp,
          realm,
          location,
          event_type,
          threat_level,
          involved_characters,
          outcome,
          access_level,
          narrative_arc_id,
          notes,
          emotional_impact
        FROM multiverse_events
        WHERE involved_characters @> $1::jsonb
        ORDER BY timestamp DESC
        LIMIT 10
      `;

      const result = await pool.query(query, [JSON.stringify([characterId])]);
      return result.rows;
    } catch (err) {
      console.error("EventGrounder.queryMultiverseEvents() error:", err.message);
      return [];
    }
  }

  /**
   * Query omiyage (gift) events for Claude as receiver or giver
   * @param {string} characterId 
   * @returns {array} Array of omiyage events
   */
  async queryOmiyageEvents(characterId) {
    try {
      const query = `
        SELECT 
          event_id,
          object_id,
          giver_character_id,
          receiver_character_id,
          event_type,
          emotional_context,
          gift_accepted,
          acceptance_notes,
          occurred_at
        FROM omiyage_events
        WHERE receiver_character_id = $1 OR giver_character_id = $1
        ORDER BY occurred_at DESC
        LIMIT 10
      `;

      const result = await pool.query(query, [characterId]);
      return result.rows;
    } catch (err) {
      console.error("EventGrounder.queryOmiyageEvents() error:", err.message);
      return [];
    }
  }

  /**
   * Query psychic events involving Claude
   * @param {string} characterId 
   * @returns {array} Array of psychic events
   */
  async queryPsychicEvents(characterId) {
    try {
      const query = `
        SELECT 
          event_id,
          event_type,
          source_character,
          target_character,
          influence_data,
          created_at,
          delta_p,
          delta_a,
          delta_d,
          half_life_seconds
        FROM psychic_events
        WHERE source_character = $1 OR target_character = $1
        ORDER BY created_at DESC
        LIMIT 10
      `;

      const result = await pool.query(query, [characterId]);
      return result.rows;
    } catch (err) {
      console.error("EventGrounder.queryPsychicEvents() error:", err.message);
      return [];
    }
  }

  /**
   * Query Tanuki level history for Claude
   * @param {string} characterId 
   * @returns {array} Array of level progression events
   */
  async queryLevelHistory(characterId) {
    try {
      const query = `
        SELECT 
          historyid,
          previouslevel,
          newlevel,
          delta,
          triggeredby,
          createdat
        FROM tanukilevelhistory
        WHERE characterid = $1
        ORDER BY createdat DESC
        LIMIT 20
      `;

      const result = await pool.query(query, [characterId]);
      return result.rows;
    } catch (err) {
      console.error("EventGrounder.queryLevelHistory() error:", err.message);
      return [];
    }
  }

  /**
   * Match entity against events
   * @param {string} query - Event type or location to search for
   * @param {array} multiverse - Multiverse events
   * @param {array} omiyage - Omiyage events
   * @param {array} psychic - Psychic events
   * @returns {object} { multiverse: [], omiyage: [], psychic: [] }
   */
  matchEvents(query, multiverse, omiyage, psychic) {
    if (!query) {
      return { multiverse: [], omiyage: [], psychic: [] };
    }

    const queryLower = query.toLowerCase();

    // Match multiverse events by realm, location, or event_type
    const multiverseMatches = multiverse.filter(event => {
      const realm = event.realm ? event.realm.toLowerCase() : "";
      const location = event.location ? event.location.toLowerCase() : "";
      const eventType = event.event_type ? event.event_type.toLowerCase() : "";
      
      return realm.includes(queryLower) || 
             location.includes(queryLower) || 
             eventType.includes(queryLower);
    });

    // Match omiyage events by event_type
    const omiyageMatches = omiyage.filter(event => {
      const eventType = event.event_type ? event.event_type.toLowerCase() : "";
      return eventType.includes(queryLower);
    });

    // Match psychic events by event_type
    const psychicMatches = psychic.filter(event => {
      const eventType = event.event_type ? event.event_type.toLowerCase() : "";
      return eventType.includes(queryLower);
    });

    return {
      multiverse: multiverseMatches,
      omiyage: omiyageMatches,
      psychic: psychicMatches
    };
  }

  /**
   * Generate grounded statement about events
   * @param {object} groundedContext - Output from ground()
   * @returns {string} Natural language statement about experiences
   */
  generateGroundedStatement(groundedContext) {
    if (!groundedContext || !groundedContext.groundedEvents) {
      return "";
    }

    const { relatedMultiverse, relatedOmiyage, relatedPsychic } = groundedContext.groundedEvents;
    let statements = [];

    // Multiverse event grounding
    if (relatedMultiverse && relatedMultiverse.length > 0) {
      const event = relatedMultiverse[0];
      const threatStr = event.threat_level ? `(threat level: ${event.threat_level})` : "";
      statements.push(`I've witnessed events in ${event.realm || "realms"} ${threatStr}.`);
    }

    // Omiyage (gift) event grounding
    if (relatedOmiyage && relatedOmiyage.length > 0) {
      const event = relatedOmiyage[0];
      const context = event.event_type || "exchange";
      statements.push(`I've experienced the intimacy of ${context}.`);
    }

    // Psychic event grounding
    if (relatedPsychic && relatedPsychic.length > 0) {
      const event = relatedPsychic[0];
      const deltaStr = event.delta_p ? `psychic influence (Î”p: ${event.delta_p})` : "psychic resonance";
      statements.push(`I carry marks of ${deltaStr} in my being.`);
    }

    return statements.join(" ");
  }
}
