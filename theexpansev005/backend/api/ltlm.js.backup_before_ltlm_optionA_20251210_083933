import express from "express";
import pool from "../db/pool.js";

const router = express.Router();

/**
 * GET /api/ltlm/training?character_id=#700002
 * Returns all LTLM training rows for a specific character.
 */
router.get("/training", async (req, res) => {
    const { character_id } = req.query;

    if (!character_id) {
        return res.status(400).json({ success: false, message: "Missing character_id" });
    }

    try {
        const result = await pool.query(
            `SELECT 
                training_id,
                speaker_character_id,
                category,
                candidate_text,
                pad_dominance,
                appropriateness_score,
                created_by,
                created_at
            FROM training_insertion_data
            WHERE speaker_character_id = $1
            ORDER BY created_at DESC`,
            [character_id]
        );

        return res.json({ success: true, rows: result.rows });
    } catch (e) {
        console.error("LTLM GET error:", e);
        return res.status(500).json({ success: false, message: "LTLM module error" });
    }
});


/**
 * POST /api/ltlm/training
 * Inserts new training rows in bulk.
 */
router.post("/training", async (req, res) => {
    const { speaker_character_id, category, pad_dominance, appropriateness_score, created_by, templates } = req.body;

    if (!character_id || !templates || !Array.isArray(templates)) {
        return res.status(400).json({ success: false, message: "Invalid payload" });
    }

    const client = await pool.connect();

    try {
        await client.query("BEGIN");

        for (const candidate_text of templates) {
            await client.query(
                `INSERT INTO training_insertion_data
                    (training_id, speaker_character_id, category, candidate_text, pad_dominance, appropriateness_score, created_by)
                 VALUES (
                    to_hex((SELECT COALESCE(MAX(('x' || SUBSTRING(training_id, 2))::bit(24)::int), 0) + 1)),
                    $1, $2, $3, $4, $5, $6
                 )`,
                [
                    speaker_character_id,
                    category,
                    candidate_text,
                    pad_dominance,
                    appropriateness_score,
                    created_by || "cms_ltlm"
                ]
            );
        }

        await client.query("COMMIT");
        return res.json({ success: true });
    } catch (e) {
        await client.query("ROLLBACK");
        console.error("LTLM POST error:", e);
        return res.status(500).json({ success: false, message: "Insert failed" });
    } finally {
        client.release();
    }
});

export default router;
