import StudentComponent from "./StudentComponent.js";
import TeacherComponent from "./TeacherComponent.js";
import EvaluatorComponent from "./EvaluatorComponent.js";
import LearningDatabase from "./LearningDatabase.js";

export default class TSELoopManager {
  constructor(pool) {
    this.pool = pool;
    this.student = new StudentComponent(pool);
    this.teacher = new TeacherComponent(pool);
    this.evaluator = new EvaluatorComponent(pool);
    this.learningDB = LearningDatabase;
    this.nodeId = null;
  }

  async initialize() {
    await this.student.initialize();
    await this.teacher.initialize();
    await this.evaluator.initialize();
    await this.learningDB.initialize();

    this.nodeId = await this.teacher.getNodeId();
    return true;
  }

  async startKnowledgeCycle({ characterId, query, domain }) {
    const cycleId = await this.learningDB.createCycle(characterId, query, domain);

    const teacherOutput = await this.teacher.generateTeaching(characterId, query);

    const studentOutput = await this.student.processLearning({
      characterId,
      query,
      teachingText: teacherOutput.explanation,
      embedding: teacherOutput.embedding
    });

    const evaluation = await this.teacher.evaluateUnderstanding({
      characterId,
      query,
      studentAnswer: studentOutput.summary
    });

    const grade = evaluation.score >= 0.75 ? 4 :
                  evaluation.score >= 0.50 ? 3 :
                  evaluation.score >= 0.25 ? 2 : 1;

    const fsrsResult = await this.evaluator.evaluateReview({
      characterId,
      knowledgeId: teacherOutput.knowledgeId,
      grade
    });

    await this.learningDB.storeCycleResult({
      cycleId,
      characterId,
      teacherOutput,
      studentOutput,
      evaluation,
      fsrs: fsrsResult.updatedState
    });

    return {
      cycle: { cycle_id: cycleId },
      overallScore: evaluation.score,
      deliveryStyle: teacherOutput.style,
      responseText: teacherOutput.explanation,
      learningProfile: studentOutput.profile,
      evaluation,
      fsrs: fsrsResult.updatedState,
      nextReview: fsrsResult.nextReview
    };
  }
}
