/** CMS Socket Handler for Terminal Namespace */
class CMSSocketHandler {
    constructor() {
        this.socket = null;
        this.connected = false;
        this.commandInput = null;
        this.outputDisplay = null;
    }

    initialize() {
        this.commandInput = document.getElementById('command-input');
        this.outputDisplay = document.getElementById('top-right-window-inner');

        if (!this.commandInput || !this.outputDisplay) {
            console.error("Required CMS elements missing");
            return;
        }

        this.connect();
        this.setupEventListeners();
    }

    connect() {
        // FULL URL REQUIRED FOR COOKIE PASSING
        this.socket = io("http://localhost:3000/terminal", {
            withCredentials: true,
            transports: ["websocket", "polling"],
            reconnection: true,
            reconnectionAttempts: 20,
            reconnectionDelay: 500,
            timeout: 20000
        });

        // EXPOSE TO WINDOW (RESTORES window.terminalSocket API)
        window.terminalSocket = this.socket;

        this.socket.on("connect", () => {
            console.log("✓ Connected to terminal WebSocket");
            this.connected = true;
            this.showStatus("Connected to terminal");
        });

        this.socket.on("disconnect", () => {
            console.log("✗ Disconnected from terminal WebSocket");
            this.connected = false;
            this.showStatus("Disconnected — please login again.");
        });

        this.socket.on("connect_error", (err) => {
            console.error("Connection error:", err);
            this.showError("WebSocket Error — Not authenticated or server unavailable.");
        });

        this.socket.on("command-response", (response) => {
            this.handleCommandResponse(response);
        });

        // === OMIYAGE LISTENERS ===
        this.socket.on("omiyage:offer", (data) => {
            console.log("[Omiyage] Offer received:", data);
            this.showOmiyageOffer(data);
        });

        this.socket.on("omiyage:fulfilled", (data) => {
            console.log("[Omiyage] Fulfilled:", data);
            this.showOmiyageFulfilled(data);
        });

        this.socket.on("omiyage:declined", (data) => {
            console.log("[Omiyage] Declined:", data);
            this.showOmiyageDeclined(data);
        });

        this.socket.on("omiyage:error", (data) => {
            console.log("[Omiyage] Error:", data);
            this.showError(`Omiyage Error: ${data.error}`);
        });
    }

    setupEventListeners() {
        this.commandInput.addEventListener("keydown", (e) => {
            if (e.key === "Enter") this.sendCommand();
        });
    }

    sendCommand() {
        const command = this.commandInput.value.trim();
        if (!command) return;

        if (!this.connected) {
            this.showError("Not connected. Please log in first.");
            return;
        }

        this.socket.emit("terminal-command", { command });
        this.commandInput.value = "";

        this.outputDisplay.innerHTML = '<div class="loading">Processing command...</div>';
    }

    handleCommandResponse(response) {
        this.outputDisplay.innerHTML = "";
        // Handle first-login welcome beat from Claude
        if (response.welcomeBeat) {
            const beat = response.welcomeBeat;
            const title = beat.title || 'Welcome';
            const template = beat.contentTemplate || {};
            const hint = template.template_hint || '';
            const speechAct = template.ltlm_speech_act || '';
            const outcome = template.ltlm_outcome_intent || '';
            const dialogueFn = template.ltlm_dialogue_function || '';

            const ltlm = beat.ltlmUtterance || null;
            const ltlmText = ltlm && ltlm.text
                ? ltlm.text
                : 'Claude does not yet have a learned welcome line for this beat.';

            const content = `
                <div class="claude-welcome">
                    <div class="welcome-title">${title}</div>
                    <div class="welcome-line">Claude: ${ltlmText}</div>
                    <div class="welcome-meta">
                        <div>Template: ${hint}</div>
                        <div>Speech act: ${speechAct}</div>
                        <div>Outcome: ${outcome}</div>
                        <div>Dialogue function: ${dialogueFn}</div>
                    </div>
                </div>
            `;

            this.showOutput(content);
            return;
        }


        if (response.error) {
            this.showError(response.error);
            return;
        }

        const intent = response.queryType || null;
        const output = response.output || response.message;
        const data = response.data || response.entityData;

        switch (intent) {
            case "EDIT_PROFILE":
                if (data && data.entity_type === "PERSON") {
                    window.renderProfileEditor(data);
                } else {
                    this.showError("Editor access denied or entity not found.");
                }
                break;

            default:
                this.showOutput(output, response.image);
                break;
        }
    }

    showStatus(message) {
        if (!this.outputDisplay) return;
        this.outputDisplay.innerHTML = `
            <div class="terminal-output">
                <div class="status-line">${message}</div>
            </div>`;
    }

    showError(message) {
        if (!this.outputDisplay) return;
        this.outputDisplay.innerHTML = `
            <div class="terminal-output">
                <div class="error-line">${message}</div>
            </div>`;
    }

    showOutput(output, imageUrl) {
        let content = output || "";

        if (imageUrl) {
            content += `
                <div class="image-wrapper">
                    <img src="${imageUrl}" alt="Result Image"
                         style="max-width:300px; max-height:300px;">
                </div>`;
        }

        this.outputDisplay.innerHTML = `
            <div class="terminal-output">
                ${content}
            </div>`;
    }
}

window.addEventListener("DOMContentLoaded", () => {
    window.cmsSocket = new CMSSocketHandler();
    window.cmsSocket.initialize();
});
