<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Expanse Admin Panel</title>
  <style>
    :root {
      --bg: #0a0a0a;
      --fg: #00ff75;
      --accent: #00ff75;
      --panel: rgba(0,32,0,0.4);
      --shadow: 0 0 20px rgba(0,255,117,0.2);
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      background: var(--bg);
      color: var(--fg);
      font-family: 'Courier New', monospace;
      min-height: 100vh;
    }
    
    .admin-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: 100vh;
    }
    
    .sidebar {
      background: var(--panel);
      border-right: 1px solid var(--accent);
      padding: 20px;
    }
    
    .sidebar h2 {
      margin-bottom: 20px;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    
    .nav-item {
      display: block;
      padding: 12px;
      margin: 5px 0;
      border: 1px solid var(--accent);
      background: transparent;
      color: var(--fg);
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
    }
    
    .nav-item:hover, .nav-item.active {
      background: rgba(0,255,117,0.1);
      box-shadow: var(--shadow);
    }
    
    .main-content {
      padding: 30px;
      overflow-y: auto;
    }
    
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 1px;
    }
    
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px;
      background: var(--panel);
      border: 1px solid var(--accent);
      color: var(--fg);
      border-radius: 4px;
      font-family: inherit;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      padding: 12px 24px;
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--fg);
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .btn:hover {
      background: rgba(0,255,117,0.1);
      box-shadow: var(--shadow);
    }
    
    .btn-danger {
      border-color: #ff0040;
      color: #ff0040;
    }
    
    .btn-danger:hover {
      background: rgba(255,0,64,0.1);
    }
    
    .data-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .data-card {
      background: var(--panel);
      border: 1px solid var(--accent);
      border-radius: 8px;
      padding: 15px;
      box-shadow: var(--shadow);
    }
    
    .data-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    
    .data-card h3 {
      margin-bottom: 10px;
    }
    
    .choice-builder {
      border: 1px solid var(--accent);
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <aside class="sidebar">
      <h2>Admin Panel</h2>
      <nav>
        <button class="nav-item active" data-section="stories">Stories</button>
        <button class="nav-item" data-section="characters">Characters</button>
      </nav>
    </aside>
    
    <main class="main-content">
      <section id="stories" class="section active">
        <h2>Story Management</h2>
        <form id="story-form" enctype="multipart/form-data">
          <div class="form-group">
            <label>Title</label>
            <input type="text" name="title" required>
          </div>
          
          <div class="form-group">
            <label>Description</label>
            <textarea name="description"></textarea>
          </div>
          
          <div class="form-group">
            <label>Category</label>
            <select name="category">
              <option>Main Quest</option>
              <option>Side Quest</option>
              <option>Exploration</option>
              <option>Combat</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Image</label>
            <input type="file" name="image" accept="image/*">
          </div>
          
          <div class="form-group">
            <label>Choices</label>
            <div id="choices-container"></div>
            <button type="button" class="btn" onclick="addChoice()">Add Choice</button>
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" name="isStartNode"> This is a starting point
            </label>
          </div>
          
          <button type="submit" class="btn">Save Story</button>
        </form>
        
        <div id="stories-list" class="data-grid"></div>
      </section>
      
      <section id="characters" class="section">
        <h2>Character Management</h2>
        <form id="character-form" enctype="multipart/form-data">
          <div class="form-group">
            <label>Name</label>
            <input type="text" name="name" required>
          </div>
          
          <div class="form-group">
            <label>Entity</label>
            <input type="text" name="entity">
          </div>
          
          <div class="form-group">
            <label>Department</label>
            <input type="text" name="department">
          </div>
          
          <div class="form-group">
            <label>Security Level</label>
            <input type="text" name="securityLevel">
          </div>
          
          <div class="form-group">
            <label>Summary</label>
            <textarea name="summary"></textarea>
          </div>
          
          <div class="form-group">
            <label>Backstory</label>
            <textarea name="backstory"></textarea>
          </div>
          
          <div class="form-group">
            <label>Abilities (comma-separated)</label>
            <input type="text" name="abilities">
          </div>
          
          <div class="form-group">
            <label>Character Image</label>
            <input type="file" name="image" accept="image/*">
          </div>
          
          <button type="submit" class="btn">Save Character</button>
        </form>
        
        <div id="characters-list" class="data-grid"></div>
      </section>
    </main>
  </div>
  
  <script>
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', function() {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        
        this.classList.add('active');
        document.getElementById(this.dataset.section).classList.add('active');
      });
    });
    
    let choiceCount = 0;
    
    function addChoice() {
      const container = document.getElementById('choices-container');
      const choiceDiv = document.createElement('div');
      choiceDiv.className = 'choice-builder';
      choiceDiv.innerHTML = `
        <div class="form-group">
          <label>Choice Text</label>
          <input type="text" name="choice-text-${choiceCount}">
        </div>
        <div class="form-group">
          <label>Leads to Story ID</label>
          <input type="text" name="choice-next-${choiceCount}">
        </div>
        <div class="form-group">
          <label>Required Items (comma-separated)</label>
          <input type="text" name="choice-items-${choiceCount}">
        </div>
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">Remove</button>
      `;
      container.appendChild(choiceDiv);
      choiceCount++;
    }
    
    document.getElementById('story-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      const choices = [];
      for (let i = 0; i < choiceCount; i++) {
        const text = formData.get(`choice-text-${i}`);
        if (text) {
          choices.push({
            text: text,
            nextStoryId: formData.get(`choice-next-${i}`),
            requiredItems: formData.get(`choice-items-${i}`)?.split(',').map(s => s.trim()) || []
          });
        }
      }
      formData.append('choices', JSON.stringify(choices));
      
      try {
        const response = await fetch('/api/admin/stories', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        
        if (response.ok) {
          alert('Story saved successfully!');
          loadStories();
          e.target.reset();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Failed to save story: ' + error.message);
      }
    });
    
    document.getElementById('character-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      try {
        const response = await fetch('/api/admin/characters', {
          method: 'POST',
          body: formData
        });
        const result = await response.json();
        
        if (response.ok) {
          alert('Character saved successfully!');
          loadCharacters();
          e.target.reset();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Failed to save character: ' + error.message);
      }
    });
    
    async function loadStories() {
      try {
        const response = await fetch('/api/admin/stories');
        const stories = await response.json();
        const container = document.getElementById('stories-list');
        
        container.innerHTML = stories.map(story => `
          <div class="data-card">
            ${story.imageUrl ? `<img src="${story.imageUrl}" alt="${story.title}">` : ''}
            <h3>${story.title}</h3>
            <p>${story.description || 'No description'}</p>
            <p>Category: ${story.category || 'Uncategorized'}</p>
            <p>Choices: ${story.choices?.length || 0}</p>
            <button class="btn btn-danger" onclick="deleteStory('${story._id}')">Delete</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load stories:', error);
      }
    }
    
    async function loadCharacters() {
      try {
        const response = await fetch('/api/admin/characters');
        const characters = await response.json();
        const container = document.getElementById('characters-list');
        
        container.innerHTML = characters.map(char => `
          <div class="data-card">
            ${char.imageUrl ? `<img src="${char.imageUrl}" alt="${char.name}">` : ''}
            <h3>${char.name}</h3>
            <p>Entity: ${char.entity || 'Unknown'}</p>
            <p>Department: ${char.department || 'Unknown'}</p>
            <p>Security: ${char.securityLevel || 'Unknown'}</p>
            <button class="btn btn-danger" onclick="deleteCharacter('${char._id}')">Delete</button>
          </div>
        `).join('');
      } catch (error) {
        console.error('Failed to load characters:', error);
      }
    }
    
    async function deleteStory(id) {
      if (!confirm('Are you sure you want to delete this story?')) return;
      
      try {
        await fetch(`/api/admin/stories/${id}`, { method: 'DELETE' });
        loadStories();
      } catch (error) {
        alert('Failed to delete story');
      }
    }
    
    async function deleteCharacter(id) {
      if (!confirm('Are you sure you want to delete this character?')) return;
      
      try {
        await fetch(`/api/admin/characters/${id}`, { method: 'DELETE' });
        loadCharacters();
      } catch (error) {
        alert('Failed to delete character');
      }
    }
    
    loadStories();
    loadCharacters();
  </script>
</body>
</html>
