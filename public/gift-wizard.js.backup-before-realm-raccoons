// Loading animation helper - updates the terminal in real-time
let loadingLineElement = null;
let loadingInterval = null;

function addLoadingLine(message = 'Searching Council Of The Wise Database') {
  // Stop any existing loading animation
  stopLoadingAnimation();
  
  // Create a line element for loading animation
  const chatLog = document.querySelector('.chat-log');
  if (!chatLog) return;
  
  loadingLineElement = document.createElement('div');
  loadingLineElement.className = 'line';
  loadingLineElement.style.color = '#00ff75';
  loadingLineElement.dataset.loading = 'true';
  loadingLineElement.textContent = `${message}...`;
  
  chatLog.appendChild(loadingLineElement);
  chatLog.scrollTop = chatLog.scrollHeight;
  
  // Start animation
  let dotCount = 0;
  loadingInterval = setInterval(() => {
    if (!loadingLineElement) return;
    dotCount = (dotCount + 1) % 4;
    const dots = '.'.repeat(dotCount);
    const spaces = ' '.repeat(3 - dotCount);
    loadingLineElement.textContent = `${message}${dots}${spaces}`;
  }, 300);
}

function stopLoadingAnimation() {
  if (loadingInterval) {
    clearInterval(loadingInterval);
    loadingInterval = null;
  }
  if (loadingLineElement) {
    loadingLineElement.remove();
    loadingLineElement = null;
  }
}

(function initGiftWizard() {
  // Single-init guard
  if (window.__giftWizardInit) return;
  window.__giftWizardInit = true;
  window.__giftWizardInitCount = (window.__giftWizardInitCount || 0) + 1;
  console.log(`üéÅ Gift Experiment Wizard initializing (count=${window.__giftWizardInitCount})`);

  // Initialize wizard state
  if (typeof window.wizardState === 'undefined') {
    window.wizardState = {
      currentStep: 1,
      realm: null,
      location: null,
      giftObject: { pleasure: 0, arousal: 0, dominance: 0 },
      giver: null,
      receiver: null,
      config: {},
      results: null
    };
  }

  // Register all listeners FIRST (before emitting)
  window.socket?.on('gift-wizard:realms', ({ success, realms }) => {
    if (!success) return;
    stopLoadingAnimation();
    console.log('[GIFT] realms received:', realms);
    showStep1();
  });

  window.socket?.on('gift-wizard:locations', ({ success, locations }) => {
    if (!success) return;
    stopLoadingAnimation();
    console.log('[GIFT] locations received:', locations.length);
    buildLocationButtons(locations);
  });

  window.socket?.on('gift-wizard:characters', ({ success, characters }) => {
    if (!success) return;
    stopLoadingAnimation();
    console.log('[GIFT] characters received:', characters.length);
    const role = wizardState.currentStep === 4 ? 'giver' : 'receiver';
    buildCharacterButtons(characters, role);
  });

  window.socket?.on('gift-wizard:event-created', ({ success, event }) => {
    if (!success) return;
    stopLoadingAnimation();
    console.log('[GIFT] event created:', event.event_id);
    window.wizardState.results = { event };
    showStep7();
  });

  window.socket?.on('gift-wizard:error', ({ error }) => {
    stopLoadingAnimation();
    console.error('[GIFT] error:', error);
    alert('Wizard Error: ' + error);
  });

  // Request realms WITH ACK fallback
  const requestRealms = () => {
    addLoadingLine('Fetching available realms');
    window.socket.emit('gift-wizard:get-realms', (res) => {
      stopLoadingAnimation();
      console.log('[GIFT] ACK realms:', res);
      if (res?.success && res.realms) {
        window.wizardState.realms = res.realms;
        showStep1();
      }
    });
  };

  if (window.socket?.connected) {
    requestRealms();
  } else {
    window.socket?.once('connect', requestRealms);
  }
})();

function showStep1() {
  const leftPanel = document.getElementById('dossier-panel');
  leftPanel.innerHTML = `
    <div style="padding: 15px; height: 100%; overflow-y: auto;">
      <h2 style="color: #00ff75; text-shadow: 0 0 10px #00ff75; margin-bottom: 20px; font-size: 14px;">
        üéÅ GIFT EXPERIMENT WIZARD
      </h2>
      
      <div style="color: #00ff75; font-size: 12px; margin-bottom: 15px;">
        STEP 1 of 7: SELECT OPERATING REALM
      </div>
      
      <div style="color: #00ff75; margin-bottom: 15px;">Choose which realm to conduct this experiment in:</div>
      
      <div id="realmButtons" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
        <div style="color: #888; font-size: 11px; padding: 10px;">Loading realms...</div>
      </div>
      
      <button onclick="returnToGodMode()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid #ffffff; color: #ffffff; font-family: 'Courier New', monospace; font-size: 11px; cursor: pointer; border-radius: 4px; font-weight: bold;">
        RETURN TO GOD MODE
      </button>
    </div>
  `;
  
  window.wizardState.currentStep = 1;
  buildRealmButtons(window.wizardState.realms || []);
}

function buildRealmButtons(realms) {
  const container = document.getElementById('realmButtons');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (!realms || realms.length === 0) {
    container.innerHTML = '<div style="color: #888; font-size: 11px;">No realms available</div>';
    return;
  }
  
  realms.forEach(realm => {
    const btn = document.createElement('button');
    btn.style.cssText = `
      padding: 10px;
      background: rgba(0,255,117,0.1);
      border: 1px solid #00ff75;
      color: #00ff75;
      cursor: pointer;
      text-align: left;
      font-family: 'Courier New', monospace;
      font-size: 11px;
      border-radius: 4px;
    `;
    btn.textContent = realm;
    btn.onclick = () => selectRealm(realm);
    container.appendChild(btn);
  });
}

function selectRealm(realm) {
  window.wizardState.realm = realm;
  addLoadingLine('Fetching locations for ' + realm);
  window.socket?.emit('gift-wizard:get-locations', { realm });
  showStep2();
}

function showStep2() {
  const leftPanel = document.getElementById('dossier-panel');
  leftPanel.innerHTML = `
    <div style="padding: 15px; height: 100%; overflow-y: auto;">
      <h2 style="color: #00ff75; text-shadow: 0 0 10px #00ff75; margin-bottom: 20px; font-size: 14px;">
        üéÅ GIFT EXPERIMENT WIZARD
      </h2>
      <div style="color: #00ff75; font-size: 12px; margin-bottom: 15px;">STEP 2 of 7: SELECT LOCATION</div>
      <div id="locationButtons" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
        <div style="color: #888; font-size: 11px; padding: 10px;">Loading locations...</div>
      </div>
      <button onclick="showStep1()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid #ffffff; color: #ffffff; font-family: 'Courier New', monospace; font-size: 11px; cursor: pointer; border-radius: 4px; font-weight: bold;">BACK</button>
    </div>
  `;
  window.wizardState.currentStep = 2;
}

function buildLocationButtons(locations) {
  const container = document.getElementById('locationButtons');
  if (!container) return;
  
  container.innerHTML = '';
  locations.forEach(loc => {
    // Create flex container for button + raccoon
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display: flex; gap: 8px; align-items: center; width: 100%;';
    
    // Create button
    const btn = document.createElement('button');
    btn.style.cssText = `flex: 1; padding: 10px; background: rgba(0,255,117,0.1); border: 1px solid #00ff75; color: #00ff75; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; border-radius: 4px; text-align: left;`;
    btn.textContent = loc.name;
    btn.onclick = () => {
      window.wizardState.location = { id: loc.location_id, name: loc.name };
      showStep3();
    };
    
    // Create raccoon using component (if available)
    const raccoon = window.createRaccoon ? window.createRaccoon({
      type: 'hex',
      hexId: loc.location_id,
      mode: 'basic',
      title: `Learn more about ${loc.name}`
    }) : null;
    
    btnContainer.appendChild(btn);
    if (raccoon) btnContainer.appendChild(raccoon);
    container.appendChild(btnContainer);
  });
}

function showStep3() {
  const leftPanel = document.getElementById('dossier-panel');
  leftPanel.innerHTML = `
    <div style="padding: 15px; height: 100%; overflow-y: auto;">
      <h2 style="color: #00ff75; text-shadow: 0 0 10px #00ff75; margin-bottom: 20px; font-size: 14px;">üéÅ GIFT EXPERIMENT WIZARD</h2>
      <div style="color: #00ff75; font-size: 12px; margin-bottom: 15px;">STEP 3 of 7: ADJUST EMOTIONAL VALENCE (PAD MODEL)</div>
      <div style="margin-bottom: 20px;">
        <label style="color: #00ff75; font-size: 11px;">PLEASURE (-1 to 1)</label>
        <input id="pleasure" type="range" min="-100" max="100" value="0" style="width: 100%; margin: 8px 0;">
        <div style="color: #888; font-size: 10px;" id="pleasureValue">0.00</div>
      </div>
      <div style="margin-bottom: 20px;">
        <label style="color: #00ff75; font-size: 11px;">AROUSAL (0 to 1)</label>
        <input id="arousal" type="range" min="0" max="100" value="50" style="width: 100%; margin: 8px 0;">
        <div style="color: #888; font-size: 10px;" id="arousalValue">0.50</div>
      </div>
      <div style="margin-bottom: 20px;">
        <label style="color: #00ff75; font-size: 11px;">DOMINANCE (0 to 1)</label>
        <input id="dominance" type="range" min="0" max="100" value="50" style="width: 100%; margin: 8px 0;">
        <div style="color: #888; font-size: 10px;" id="dominanceValue">0.50</div>
      </div>
      <button onclick="savePADAndContinue()" style="width: 100%; padding: 10px; background: rgba(0,255,117,0.2); border: 2px solid #00ff75; color: #00ff75; font-family: 'Courier New', monospace; font-size: 12px; cursor: pointer; border-radius: 4px; font-weight: bold; margin-bottom: 8px;">NEXT: SELECT CHARACTERS</button>
      <button onclick="showStep2()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid #ffffff; color: #ffffff; font-family: 'Courier New', monospace; font-size: 11px; cursor: pointer; border-radius: 4px;">BACK</button>
    </div>
  `;
  
  document.getElementById('pleasure').oninput = () => {
    document.getElementById('pleasureValue').textContent = (document.getElementById('pleasure').value / 100).toFixed(2);
  };
  document.getElementById('arousal').oninput = () => {
    document.getElementById('arousalValue').textContent = (document.getElementById('arousal').value / 100).toFixed(2);
  };
  document.getElementById('dominance').oninput = () => {
    document.getElementById('dominanceValue').textContent = (document.getElementById('dominance').value / 100).toFixed(2);
  };
}

function savePADAndContinue() {
  window.wizardState.giftObject = {
    pleasure: parseFloat((document.getElementById('pleasure').value / 100).toFixed(2)),
    arousal: parseFloat((document.getElementById('arousal').value / 100).toFixed(2)),
    dominance: parseFloat((document.getElementById('dominance').value / 100).toFixed(2))
  };
  showStep4();
  addLoadingLine('Fetching characters');
  window.socket?.emit('gift-wizard:get-characters', { realm: window.wizardState.realm }, (res) => {
    if (res?.success) buildCharacterButtons(res.characters, 'giver');
  });
}

function showStep4() {
  const leftPanel = document.getElementById('dossier-panel');
  leftPanel.innerHTML = `
    <div style="padding: 15px; height: 100%; overflow-y: auto;">
      <h2 style="color: #00ff75; text-shadow: 0 0 10px #00ff75; margin-bottom: 20px; font-size: 14px;">üéÅ GIFT EXPERIMENT WIZARD</h2>
      <div style="color: #00ff75; font-size: 12px; margin-bottom: 15px;">STEP 4 of 7: SELECT GIVER CHARACTER</div>
      <div id="giverButtons" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
        <div style="color: #888; font-size: 11px; padding: 10px;">Loading characters...</div>
      </div>
      <button onclick="showStep3()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid #ffffff; color: #ffffff; font-family: 'Courier New', monospace; font-size: 11px; cursor: pointer; border-radius: 4px;">BACK</button>
    </div>
  `;
  window.wizardState.currentStep = 4;
}

function buildCharacterButtons(characters, role) {
  const containerId = role === 'giver' ? 'giverButtons' : 'receiverButtons';
  const container = document.getElementById(containerId);
  if (!container) return;
  
  container.innerHTML = '';
  characters.forEach(char => {
    // Create flex container for button + raccoon
    const btnContainer = document.createElement('div');
    btnContainer.style.cssText = 'display: flex; gap: 8px; align-items: center; width: 100%;';
    
    // Create button
    const btn = document.createElement('button');
    btn.style.cssText = `flex: 1; padding: 10px; background: rgba(0,255,117,0.1); border: 1px solid #00ff75; color: #00ff75; cursor: pointer; font-family: 'Courier New', monospace; font-size: 11px; border-radius: 4px; text-align: left;`;
    btn.textContent = `${char.character_name} [${char.category}]`;
    btn.onclick = () => {
      if (role === 'giver') {
        window.wizardState.giver = { id: char.character_id, name: char.character_name };
        showStep5();
      } else {
        window.wizardState.receiver = { id: char.character_id, name: char.character_name };
        showStep6();
      }
    };
    
    // Create raccoon using component (if available)
    const raccoon = window.createRaccoon ? window.createRaccoon({
      type: 'hex',
      hexId: char.character_id,
      mode: 'basic',
      title: `Learn more about ${char.character_name}`
    }) : null;
    
    btnContainer.appendChild(btn);
    if (raccoon) btnContainer.appendChild(raccoon);
    container.appendChild(btnContainer);
  });
}

function showStep5() {
  const leftPanel = document.getElementById('dossier-panel');
  leftPanel.innerHTML = `
    <div style="padding: 15px; height: 100%; overflow-y: auto;">
      <h2 style="color: #00ff75; text-shadow: 0 0 10px #00ff75; margin-bottom: 20px; font-size: 14px;">üéÅ GIFT EXPERIMENT WIZARD</h2>
      <div style="color: #00ff75; font-size: 12px; margin-bottom: 15px;">STEP 5 of 7: SELECT RECEIVER CHARACTER</div>
      <div id="receiverButtons" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px;">
        <div style="color: #888; font-size: 11px; padding: 10px;">Loading characters...</div>
      </div>
      <button onclick="showStep4()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid #ffffff; color: #ffffff; font-family: 'Courier New', monospace; font-size: 11px; cursor: pointer; border-radius: 4px;">BACK</button>
    </div>
  `;
  window.wizardState.currentStep = 5;
  addLoadingLine('Fetching characters');
  window.socket?.emit('gift-wizard:get-characters', { realm: window.wizardState.realm }, (res) => {
    if (res?.success) buildCharacterButtons(res.characters, 'receiver');
  });
}

function showStep6() {
  const leftPanel = document.getElementById('dossier-panel');
  const evt = window.wizardState;
  leftPanel.innerHTML = `
    <div style="padding: 15px; height: 100%; overflow-y: auto;">
      <h2 style="color: #00ff75; text-shadow: 0 0 10px #00ff75; margin-bottom: 20px; font-size: 14px;">üéÅ GIFT EXPERIMENT WIZARD</h2>
      <div style="color: #00ff75; font-size: 12px; margin-bottom: 15px;">STEP 6 of 7: REVIEW & EXECUTE</div>
      <div style="background: rgba(0,255,117,0.05); padding: 12px; border-radius: 4px; margin-bottom: 15px; border: 1px solid rgba(0,255,117,0.2);">
        <div style="color: #00ff75; font-size: 11px; margin-bottom: 10px; font-weight: bold;">EXPERIMENT CONFIGURATION:</div>
        <div style="color: #888; font-size: 10px; line-height: 1.6;">
          <div>üéÅ Gift PAD: P=${evt.giftObject.pleasure}, A=${evt.giftObject.arousal}, D=${evt.giftObject.dominance}</div>
          <div>üë§ Giver: ${evt.giver?.name || 'N/A'}</div>
          <div>üë§ Receiver: ${evt.receiver?.name || 'N/A'}</div>
          <div>üìç Location: ${evt.location?.name || 'N/A'}</div>
          <div>üåç Realm: ${evt.realm || 'N/A'}</div>
        </div>
      </div>
      <button onclick="executeGiftExchange()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: rgba(0,255,117,0.3); border: 2px solid #00ff75; color: #00ff75; font-family: 'Courier New', monospace; font-size: 12px; cursor: pointer; border-radius: 4px; font-weight: bold;">‚ö° EXECUTE GIFT EXCHANGE</button>
      <button onclick="showStep5()" style="width: 100%; padding: 10px; background: rgba(255,255,255,0.1); border: 2px solid #ffffff; color: #ffffff; font-family: 'Courier New', monospace; font-size: 11px; cursor: pointer; border-radius: 4px;">BACK</button>
    </div>
  `;
}

function executeGiftExchange() {
  const evt = window.wizardState;
  if (!evt.realm || !evt.location?.id || !evt.giver?.id || !evt.receiver?.id) {
    console.warn('[GIFT] Missing required fields', evt);
    alert('Please complete all steps before executing.');
    return;
  }
  addLoadingLine('Executing gift exchange');
  window.socket?.emit('gift-wizard:create-event', {
    realm: evt.realm,
    location_id: evt.location.id,
    giver_id: evt.giver.id,
    receiver_id: evt.receiver.id,
    outcome: 'success',
    notes: `Gift exchange between ${evt.giver.name} and ${evt.receiver.name}`
  });
}

function showStep7() {
  const leftPanel = document.getElementById('dossier-panel');
  const event = window.wizardState.results?.event;
  leftPanel.innerHTML = `
    <div style="padding: 15px; height: 100%; overflow-y: auto;">
      <h2 style="color: #00ff75; text-shadow: 0 0 10px #00ff75; margin-bottom: 20px; font-size: 14px;">üéÅ GIFT EXPERIMENT WIZARD</h2>
      <div style="color: #00ff75; font-size: 12px; margin-bottom: 15px;">STEP 7 of 7: RESULTS & IMPACT</div>
      <div style="background: rgba(0,255,117,0.05); padding: 12px; border-radius: 4px; margin-bottom: 15px; border: 1px solid rgba(0,255,117,0.2);">
        <div style="color: #00ff75; font-size: 11px; margin-bottom: 10px; font-weight: bold;">‚úÖ GIFT EXCHANGE EXECUTED</div>
        <div style="color: #888; font-size: 10px; line-height: 1.8;">
          <div>Event ID: ${event?.event_id || 'N/A'}</div>
          <div>Status: ${event?.outcome || 'success'}</div>
          <div>Timestamp: ${event?.timestamp || 'N/A'}</div>
        </div>
      </div>
      <button onclick="returnToGodMode()" style="width: 100%; padding: 10px; background: rgba(0,255,117,0.2); border: 2px solid #00ff75; color: #00ff75; font-family: 'Courier New', monospace; font-size: 11px; cursor: pointer; border-radius: 4px; font-weight: bold;">‚úÖ COMPLETE & RETURN TO GOD MODE</button>
    </div>
  `;
}

function returnToGodMode() {
  if (typeof initAdminPanel === 'function') {
    initAdminPanel();
  }
}
