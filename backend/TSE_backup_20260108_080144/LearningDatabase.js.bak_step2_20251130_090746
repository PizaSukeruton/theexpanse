import pool from "../db/pool.js";
import generateHexId from "../utils/hexIdGenerator.js";

export default class LearningDatabase {

    constructor(dbPool) {
        this.pool = dbPool || pool;
    }

    async createCycle(acquired) {
        const client = await this.pool.connect();
        try {
            await client.query("BEGIN");

            let knowledgeId = acquired.knowledge_id;   // may exist if reused
            let isReused = acquired.reused === true;

            // ------------------------------------------------------
            // CASE 1 — REUSED KNOWLEDGE (already exists in DB)
            // ------------------------------------------------------
            if (isReused) {
                // nothing to insert, DB row already exists
                await client.query("COMMIT");
                return {
                    status: "ok",
                    reused: true,
                    knowledge: acquired
                };
            }

            // ------------------------------------------------------
            // CASE 2 — BRAND NEW KNOWLEDGE (must insert)
            // ------------------------------------------------------
            knowledgeId = await generateHexId("knowledge_item_id");

            const insertKnowledge = `
                INSERT INTO knowledge_items (
                    knowledge_id,
                    content,
                    semantic_embedding,
                    domain_id,
                    source_type,
                    acquisition_timestamp,
                    initial_character_id,
                    initial_strength,
                    complexity_score,
                    concept
                )
                VALUES ($1,$2,$3,$4,'tse_cycle',NOW(),$5,$6,$7,$8)
                RETURNING *
            `;

            const inserted = await client.query(insertKnowledge, [
                knowledgeId,
                acquired.content,
                null,
                acquired.domainId || null,
                acquired.characterId,
                1,
                acquired.complexity_score || 0.5,
                acquired.concept
            ]);

            await client.query("COMMIT");

            return {
                status: "ok",
                reused: false,
                knowledge: inserted.rows[0]
            };

        } catch (err) {
            await client.query("ROLLBACK");
            console.error("[LearningDB.createCycle] ERROR:", err);
            throw err;
        } finally {
            client.release();
        }
    }
}
