import pool from "../db/pool.js";
import generateHexId from "../utils/hexIdGenerator.js";

export default class LearningDatabase {

    constructor(db) {
        this.pool = db;
    }

    /*
    |--------------------------------------------------------------------------
    | 1. CREATE KNOWLEDGE ACQUISITION CYCLE
    |--------------------------------------------------------------------------
    */
    async createCycle(acquired) {
        const {
            characterId,
            knowledgeId,
            content,
            domainId,
            sourceType,
            concept
        } = acquired;

        const query = `
            INSERT INTO knowledge_items (
                knowledge_id,
                content,
                semantic_embedding,
                domain_id,
                source_type,
                initial_character_id,
                initial_strength,
                complexity_score,
                concept
            )
            VALUES ($1, $2, null, $3, $4, $5, 1, 0.5, $6)
            RETURNING *
        `;

        const result = await this.pool.query(query, [
            knowledgeId,
            content,
            domainId,
            sourceType,
            characterId,
            concept
        ]);

        return { status: "ok", message: "Knowledge cycle created", knowledge: result.rows[0] };
    }

    /*
    |--------------------------------------------------------------------------
    | 2. REVIEW KNOWLEDGE (FSRS EVENT)
    |--------------------------------------------------------------------------
    */
    async reviewKnowledge(characterId, knowledgeId, grade) {
        const reviewId = await generateHexId("tse_evaluation_record_id");

        const query = `
            INSERT INTO knowledge_review_logs (
                log_id,
                character_id,
                knowledge_id,
                grade,
                previous_interval,
                new_interval,
                retrievability_at_review
            )
            VALUES ($1, $2, $3, $4, 1, 1, 1)
            RETURNING *
        `;

        const result = await this.pool.query(query, [
            reviewId,
            characterId,
            knowledgeId,
            grade
        ]);

        return result.rows[0];
    }
}
