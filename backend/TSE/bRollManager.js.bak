// backend/TSE/bRollManager.js
// @name B-Roll Character Manager
// @description Manages autonomous behavior for B-Roll Chaos and Machine characters.
// @version 1.0.0

const pool = require('../db/pool'); // Assumes db/pool.js exists and exports a pg.Pool instance

const B_ROLL_CATEGORIES = ['B-Roll Chaos', 'Machines'];

/**
 * Retrieves all characters designated as B-roll and currently marked for autonomous behavior.
 * @returns {Promise<Array>} A promise that resolves to an array of B-roll character profiles.
 */
async function getAutonomousBRollCharacters() {
    try {
        const query = `
            SELECT character_id, character_name, category, is_b_roll_autonomous
            FROM character_profiles
            WHERE category IN ($1, $2) AND is_b_roll_autonomous = TRUE;
        `;
        const result = await pool.query(query, B_ROLL_CATEGORIES);
        console.log(`[bRollManager] Found ${result.rows.length} active B-Roll characters.`);
        return result.rows;
    } catch (error) {
        console.error('[bRollManager] Error fetching autonomous B-Roll characters:', error.message);
        throw new Error('Failed to retrieve autonomous B-Roll characters.');
    }
}

/**
 * Toggles the autonomous behavior flag for a specified B-roll character.
 * This operation is protected by the database constraint, which ensures non-B-roll
 * characters cannot have this flag set to TRUE/FALSE (it must remain NULL).
 * @param {string} characterId - The hex ID of the character to update.
 * @param {boolean} enable - True to enable autonomy, false to disable.
 * @returns {Promise<boolean>} True if the update was successful, false otherwise.
 */
async function toggleBRollAutonomy(characterId, enable) {
    try {
        // First, verify the character's category to provide a more descriptive error if needed
        const categoryCheck = await pool.query(
            `SELECT category FROM character_profiles WHERE character_id = $1;`,
            [characterId]
        );
        const character = categoryCheck.rows[0];

        if (!character) {
            throw new Error(`Character with ID ${characterId} not found.`);
        }

        if (!B_ROLL_CATEGORIES.includes(character.category)) {
            // This is primarily for a more user-friendly error message; the DB constraint
            // would also catch this if `enable` is not NULL.
            throw new Error(`Character ${character.character_name} (ID: ${characterId}) is not a B-Roll character and cannot have autonomy toggled.`);
        }

        const query = `
            UPDATE character_profiles
            SET is_b_roll_autonomous = $1, updated_at = CURRENT_TIMESTAMP
            WHERE character_id = $2 AND category IN ($3, $4)
            RETURNING character_id, is_b_roll_autonomous;
        `;
        const result = await pool.query(query, [enable, characterId, B_ROLL_CATEGORIES[0], B_ROLL_CATEGORIES[1]]);

        if (result.rowCount === 0) {
            console.warn(`[bRollManager] Failed to toggle autonomy for ${characterId}. No rows updated.`);
            return false;
        }
        console.log(`[bRollManager] Toggled autonomy for character ${characterId} to ${enable}.`);
        return true;
    } catch (error) {
        console.error(`[bRollManager] Error toggling B-Roll autonomy for ${characterId}:`, error.message);
        throw error; // Re-throw to be caught by API endpoint error handler
    }
}

/**
 * Placeholder for future complex B-roll behavior simulation logic.
 * This function will be expanded after deep research into behavioral modes and parameters.
 * For now, it simply logs a message.
 * @param {object} characterProfile - The profile of the B-roll character to simulate.
 */
function simulateBRollBehavior(characterProfile) {
    if (!characterProfile.is_b_roll_autonomous) {
        // This character is not set to be autonomous or is not a B-Roll character
        return;
    }
    console.log(`[bRollManager] Simulating autonomous behavior for: ${characterProfile.character_name} (ID: ${characterProfile.character_id})`);
    // Future logic here:
    // - Based on characterProfile.b_roll_mode, characterProfile.activity_level, etc.
    // - Potentially interact with a game world state (e.g., move in a scene)
    // - Generate ambient events or simple reactions
}

module.exports = {
    getAutonomousBRollCharacters,
    toggleBRollAutonomy,
    simulateBRollBehavior
};
