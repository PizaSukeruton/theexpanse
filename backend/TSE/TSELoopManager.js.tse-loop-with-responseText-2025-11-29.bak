import generateHexId from '../utils/hexIdGenerator.js';
import pkg from 'pg';
const { Pool } = pkg;

import TeacherComponent from './TeacherComponent.js';
import StudentComponent from './StudentComponent.js';
import EvaluationComponent from './EvaluationComponent.js';
import BeltProgressionManager from './BeltProgressionManager.js';
import PerformanceMonitor from './PerformanceMonitor.js';
import KnowledgeResponseEngine from './helpers/KnowledgeResponseEngine.js';
import { scoreStoryVsSequenceAttempt } from '../StorySenseEngine.mjs';

class TSELoopManager {
    constructor(pool) {
        if (!pool) {
            throw new Error("Database pool is required for TSELoopManager");
        }
        this.pool = pool;
        this.learningDatabase = null;
        this.performanceMonitor = new PerformanceMonitor(pool);
        this.teacherComponent = new TeacherComponent(pool);
        this.studentComponent = new StudentComponent(pool);
        this.evaluationComponent = null;
        this.beltProgressionManager = new BeltProgressionManager(pool);
        this.hexCounter = null;
    }

    async initialize() {
        const LearningDatabase = (await import('./LearningDatabase.js')).default;
        this.learningDatabase = new LearningDatabase(this.pool);
        await this.learningDatabase.initializeCounters();
        this.evaluationComponent = new EvaluationComponent(this.pool, this.learningDatabase, this.performanceMonitor);
        await this.teacherComponent.initialize();
        await this.studentComponent.initialize();
        await this.initializeHexCounter();
        console.log("TSELoopManager initialized. Next cycle ID hex:", this.hexCounter.toString(16).toUpperCase());
    }

    async initializeHexCounter() {
        const result = await this.pool.query(`
            SELECT cycleid
            FROM tsecycles
            WHERE cycleid >= '#800000' AND cycleid <= '#80FFFF'
            ORDER BY cycleid DESC
            LIMIT 1
        `);

        if (result.rows.length > 0) {
            this.hexCounter = parseInt(result.rows[0].cycleid.substring(1), 16) + 1;
        } else {
            this.hexCounter = 0x800000;
        }
    }

    async generateCycleId() {
        return await generateHexId('tse_cycle_id');
    }
    async startKnowledgeCycle({ characterId, query = null, domain = null }) {
        if (domain) {
            const cycle_id = await this.generateCycleId();
            const client = await this.pool.connect();

            try {
                await client.query('BEGIN');

                const cycleMetadata = {
                    module: 'knowledge_learning',
                    characterId: characterId,
                    domain: domain,
                    startTime: new Date().toISOString()
                };

                const cycleQuery = `
                    INSERT INTO tse_cycles (
                        cycle_id, cycle_type, status, cultural_compliance
                    ) VALUES ($1, $2, $3, $4)
                `;

                await client.query(cycleQuery, [
                    cycle_id,
                    'knowledge_learning',
                    'running',
                    cycleMetadata
                ]);

                console.log(`[TSE-STORY] Knowledge cycle started: ${cycle_id} for ${characterId}`);

                const teacherData = await this.teacherComponent.handleKnowledgeCycle(cycle_id, characterId, query, domain, client);
                const studentData = await this.studentComponent.handleKnowledgeCycle(
                    cycle_id,
                    characterId,
                    teacherData.algorithm_decision.taskTypeId,
                    teacherData.record_id,
                    client
                );

                await client.query('COMMIT');

                console.log('[DEBUG] studentData:', JSON.stringify(studentData, null, 2));

                const evaluationResult = await this.evaluationComponent.performAnalysis(
                    cycle_id,
                    teacherData.record_id,
                    studentData.student_record_id,
                    1
                );

                await client.query('BEGIN');

                console.log('[TSE-Eval] Evaluation complete:', evaluationResult.record_id, 'Score:', evaluationResult.score);

                const beltUpdate = await this.beltProgressionManager.updateProgressionFromEvaluation(
                    characterId,
                    evaluationResult
                );

                console.log('[TSE-Belt] Progression updated:', beltUpdate);

        const knowledgeEngine = new KnowledgeResponseEngine(this.pool);
        await knowledgeEngine.initialize();
        const knowledgeResponse = await knowledgeEngine.generateKnowledgeResponse(
          characterId,
          query,
          { domain }
        );

                await client.query('COMMIT');

                return {
                    cycle: { cycle_id, domain },
                    teacher: teacherData,
                    student: studentData,
                    evaluation: {
                        record_id: evaluationResult.record_id,
                        effectiveness_score: evaluationResult.effectiveness_score,
                        efficiency_score: evaluationResult.efficiency_score,
                        innovation_score: evaluationResult.innovation_score,
                        cultural_score: evaluationResult.cultural_score,
                        weighted_score: evaluationResult.score
                    },
                    responseText: knowledgeResponse,
                    belt_progression: beltUpdate
                };
            } catch (error) {
                await client.query('ROLLBACK');
                console.error(`[TSE] Failed knowledge cycle ${cycle_id}:`, error);
                throw error;
            } finally {
                client.release();
            }
        }
    }
}

export default TSELoopManager;
