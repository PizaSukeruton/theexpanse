import express from "express";
const router = express.Router();

import pool from "../db/pool.js";
import TSELoopManager from "./TSELoopManager.js";
import EvaluatorComponent from "./EvaluatorComponent.js";

const tseManager = getTSELoopManager();
await tseManager.initialize();

const evaluator = new EvaluatorComponent(pool);
await evaluator.initialize();

router.get("/", (req, res) => {
  res.json({
    message: "TSE Pipeline API",
    endpoints: [
      "/cycle/knowledge",
      "/review"
    ]
  });
});

router.post("/cycle/knowledge", async (req, res) => {
  try {
    const { characterId, query, domain } = req.body;

    if (!characterId || !query) {
      return res.status(400).json({
        error: "Missing required fields: characterId and query"
      });
    }

    const cycle = await tseManager.startKnowledgeCycle({
      characterId,
      query,
      domain: domain || "general"
    });

    res.json({
      success: true,
      ...cycle
    });

  } catch (err) {
    console.error("[TSE API] Knowledge cycle error:", err);
    res.status(500).json({
      error: err.message
    });
  }
});

router.post("/review", async (req, res) => {
  try {
    const { characterId, knowledgeId, grade } = req.body;

    if (!characterId || !knowledgeId || grade === undefined) {
      return res.status(400).json({
        error: "Missing required fields: characterId, knowledgeId, grade"
      });
    }

    const result = await evaluator.evaluateReview({
      characterId,
      knowledgeId,
      grade
    });

    res.json({
      success: true,
      fsrs: result.updatedState,
      nextReview: result.nextReview
    });

  } catch (err) {
    console.error("[TSE API] Review error:", err);
    res.status(500).json({
      error: err.message
    });
  }
});

export default router;
