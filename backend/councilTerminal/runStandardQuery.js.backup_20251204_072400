import cotwQueryEngine from "./cotwQueryEngine.js";

async function routeTSEKnowledgeIfApplicable(intent, command) {
  const questionTypes = ["WHO", "WHAT", "WHEN", "WHY", "HOW", "WHICH", "IS", "CAN"];
  if (!intent || !intent.type || !questionTypes.includes(intent.type)) return null;

  const lower = command.toLowerCase();
  if (!lower.includes("pokemon")) return null;

  try {
    const res = await fetch("http://localhost:3000/api/tse/knowledge/response", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        characterId: "#700002",
        query: command,
        domain: "pokemon"
      })
    });

    if (!res.ok) return null;
    const data = await res.json();
    if (!data.success || !data.response) return null;

    return data.response;
  } catch (err) {
    console.error("TSE route failed:", err.message);
    return null;
  }
}

export default async function runStandardQuery(intentResult, user) {
  if (!intentResult || !intentResult.type) {
    return { output: "Unable to process query – invalid intentResult", queryType: null };
  }

  const command = intentResult.original || intentResult.entity || "";

  // Execute normal COTW query
  const result = await cotwQueryEngine.executeQuery(intentResult, user);

  // Check if TSE should override
  const tseResponse = await routeTSEKnowledgeIfApplicable(intentResult, command);
  if (tseResponse) {
    return {
      output: tseResponse.knowledge,
      statusMessage: `INTENT: ${intentResult.type} (${
        intentResult.confidence?.toFixed ? intentResult.confidence.toFixed(2) : intentResult.confidence
      }) – Routed to TSE (domain: pokemon)`,
      queryType: intentResult.type,
      image: tseResponse.image || null,
      entityUsed: intentResult.entity || null,
      entityType: result?.data?.entity_type || null
    };
  }

  // If COTW returned nothing
  if (!result) {
    return { output: "No response generated." };
  }

  // Image resolution
  const imageUrl =
    result.image ||
    (result.data && (result.data.image_url || result.data.profile_image)) ||
    null;

  const output = result.message || "No message generated.";

  return {
    output,
    image: imageUrl,
    entityUsed: intentResult.entity || null,
    entityType: result.data?.entity_type || null,
    queryType: intentResult.type,
    action: result.action || null,
    realm: result.realm || null
  };
}

