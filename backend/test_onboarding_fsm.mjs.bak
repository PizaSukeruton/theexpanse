/**
 * FSM Integration Tests
 * Tests the OnboardingOrchestrator and socket handler integration
 * Run with: node backend/test_onboarding_fsm.mjs
 */

import onboardingOrchestrator from './services/OnboardingOrchestrator.js';
import pool from './db/pool.js';

// Test utilities
const TEST_USERNAMES = ['James1', 'James2', 'James3'];
let testUserIds = [];
let testsPassed = 0;
let testsFailed = 0;

async function getTestUserIds() {
  console.log('üîç Looking up test user IDs...');
  for (const username of TEST_USERNAMES) {
    const result = await pool.query(
      'SELECT user_id FROM users WHERE username = $1',
      [username]
    );
    if (result.rows.length > 0) {
      testUserIds.push(result.rows[0].user_id);
      console.log(`  ‚úì ${username}: ${result.rows[0].user_id}`);
    } else {
      console.warn(`  ‚ö†Ô∏è  ${username}: Not found in database`);
    }
  }
  
  if (testUserIds.length === 0) {
    throw new Error('No test users found! Create James1, James2, James3 first.');
  }
  
  console.log(`\n‚úì Found ${testUserIds.length} test user(s)\n`);
}

async function cleanupTestUser(userId) {
  await pool.query('DELETE FROM user_onboarding_audit WHERE user_id = $1', [userId]);
  await pool.query('DELETE FROM user_onboarding_state WHERE user_id = $1', [userId]);
  await pool.query('DELETE FROM omiyage_choice_state WHERE user_id = $1', [userId]);
}

async function assert(condition, testName) {
  if (condition) {
    console.log(`‚úÖ PASS: ${testName}`);
    testsPassed++;
  } else {
    console.error(`‚ùå FAIL: ${testName}`);
    testsFailed++;
  }
}

// ============================================================================
// TEST 1: First Login ‚Üí awaiting_ready
// ============================================================================
async function test1_firstLogin() {
  console.log('\n=== TEST 1: First Login Flow (James1) ===');
  
  const testUserId = testUserIds[0];
  await cleanupTestUser(testUserId);
  
  // Initialize user (simulates first connection)
  await onboardingOrchestrator.initializeUser(testUserId);
  let state = await onboardingOrchestrator.getCurrentState(testUserId);
  
  await assert(state.current_state === 'new', 'User starts in "new" state');
  
  // Simulate welcome flow (uses atomic helper)
  await onboardingOrchestrator.advanceToAwaitingReadyAfterWelcome(
    testUserId,
    '#BEAT01' // Mock beat ID
  );
  
  state = await onboardingOrchestrator.getCurrentState(testUserId);
  
  await assert(state.current_state === 'awaiting_ready', 'User advances to "awaiting_ready"');
  await assert(state.state_data.welcome_beat_id === '#BEAT01', 'Welcome beat ID stored');
  
  // Check audit trail
  const audit = await pool.query(
    'SELECT COUNT(*) as count FROM user_onboarding_audit WHERE user_id = $1',
    [testUserId]
  );
  
  await assert(parseInt(audit.rows[0].count) === 2, 'Single audit entry for atomic transition');
}

// ============================================================================
// TEST 2: Reconnect Resumes Correctly
// ============================================================================
async function test2_reconnectResume() {
  console.log('\n=== TEST 2: Reconnect During Onboarding (James1) ===');
  
  const testUserId = testUserIds[0];
  
  // Set user to mid-flow state
  await cleanupTestUser(testUserId);
  await onboardingOrchestrator.initializeUser(testUserId);
  await onboardingOrchestrator.advanceToAwaitingReadyAfterWelcome(testUserId, '#BEAT02');
  
  // Simulate reconnect - just load state
  const state = await onboardingOrchestrator.getCurrentState(testUserId);
  
  await assert(state.current_state === 'awaiting_ready', 'Reconnect loads correct state');
  await assert(state.state_data.welcome_beat_id === '#BEAT02', 'State data persisted');
  await assert(state.state_version >= 1, 'Version number exists');
}

// ============================================================================
// TEST 3: Double "Yes" ‚Üí One Success, One No-Op
// ============================================================================
async function test3_doubleYes() {
  console.log('\n=== TEST 3: Concurrent Affirmative - Double Yes (James2) ===');
  
  const testUserId = testUserIds[1] || testUserIds[0]; // Fallback to James1 if only 1 user
  await cleanupTestUser(testUserId);
  
  // Setup: User at awaiting_ready
  await onboardingOrchestrator.initializeUser(testUserId);
  await onboardingOrchestrator.advanceToAwaitingReadyAfterWelcome(testUserId, '#BEAT03');
  
  let state = await onboardingOrchestrator.getCurrentState(testUserId);
  const versionBefore = state.state_version;
  
  // First "yes" - should succeed
  await onboardingOrchestrator.transitionTo(
    testUserId,
    'omiyage_offered',
    {},
    'user_affirmative_1'
  );
  
  state = await onboardingOrchestrator.getCurrentState(testUserId);
  
  await assert(state.current_state === 'omiyage_offered', 'First affirmative succeeds');
  await assert(state.state_version === versionBefore + 1, 'Version incremented');
  
  // Second "yes" - should fail with InvalidTransitionError
  let caughtError = false;
  try {
    await onboardingOrchestrator.transitionTo(
      testUserId,
      'omiyage_offered',
      {},
      'user_affirmative_2',
      versionBefore // Using old version
    );
  } catch (err) {
    if (err.name === 'InvalidTransitionError') {
      // Already in omiyage_offered, can't transition to it again
      caughtError = true;
    }
  }
  
  await assert(caughtError, 'Second affirmative prevented (invalid transition)');
}

// ============================================================================
// TEST 4: Reconnect During Omiyage
// ============================================================================
async function test4_reconnectDuringOmiyage() {
  console.log('\n=== TEST 4: Reconnect During Omiyage Selection (James2) ===');
  
  const testUserId = testUserIds[1] || testUserIds[0];
  await cleanupTestUser(testUserId);
  
  // Setup: User at omiyage_offered
  await onboardingOrchestrator.initializeUser(testUserId);
  await onboardingOrchestrator.advanceToAwaitingReadyAfterWelcome(testUserId, '#BEAT04');
  await onboardingOrchestrator.transitionTo(testUserId, 'omiyage_offered', {}, 'test_setup');
  
  // Simulate reconnect
  const state = await onboardingOrchestrator.getCurrentState(testUserId);
  
  await assert(state.current_state === 'omiyage_offered', 'Reconnect shows omiyage_offered state');
  
  // Simulate completion
  await onboardingOrchestrator.transitionTo(
    testUserId,
    'onboarded',
    { choice_id: '#OBJ001' },
    'omiyage_accepted'
  );
  
  const finalState = await onboardingOrchestrator.getCurrentState(testUserId);
  
  await assert(finalState.current_state === 'onboarded', 'User can complete from reconnect');
  await assert(finalState.state_data.choice_id === '#OBJ001', 'Choice ID persisted');
}

// ============================================================================
// TEST 5: Admin Override Audit Trail
// ============================================================================
async function test5_adminOverride() {
  console.log('\n=== TEST 5: Admin Override with Audit Trail (James3) ===');
  
  const testUserId = testUserIds[2] || testUserIds[0]; // Fallback to James1 if only 1 user
  await cleanupTestUser(testUserId);
  
  // Setup: User stuck in middle state
  await onboardingOrchestrator.initializeUser(testUserId);
  await onboardingOrchestrator.advanceToAwaitingReadyAfterWelcome(testUserId, '#BEAT05');
  
  // Admin override - force to onboarded
  await onboardingOrchestrator.transitionTo(
    testUserId,
    'onboarded',
    { admin_override: true },
    'admin_force_complete_by_#ADMIN1'
  );
  
  const state = await onboardingOrchestrator.getCurrentState(testUserId);
  
  await assert(state.current_state === 'onboarded', 'Admin can force state change');
  
  // Check audit trail has clear reason
  const audit = await pool.query(
    'SELECT reason FROM user_onboarding_audit WHERE user_id = $1 ORDER BY transitioned_at DESC LIMIT 1',
    [testUserId]
  );
  
  await assert(
    audit.rows[0].reason.includes('admin_force'),
    'Audit trail contains admin override reason'
  );
}

// ============================================================================
// RUN ALL TESTS
// ============================================================================
async function runAllTests() {
  console.log('üß™ Starting FSM Integration Tests...\n');
  
  try {
    await getTestUserIds();
    
    await test1_firstLogin();
    await test2_reconnectResume();
    await test3_doubleYes();
    await test4_reconnectDuringOmiyage();
    await test5_adminOverride();
    
    console.log('\n' + '='.repeat(50));
    console.log(`‚úÖ Tests Passed: ${testsPassed}`);
    console.log(`‚ùå Tests Failed: ${testsFailed}`);
    console.log('='.repeat(50));
    
    if (testsFailed === 0) {
      console.log('\nüéâ All tests passed! FSM integration is working correctly.\n');
    } else {
      console.log('\n‚ö†Ô∏è  Some tests failed. Review output above.\n');
      process.exit(1);
    }
    
  } catch (err) {
    console.error('\nüí• Test suite crashed:', err);
    process.exit(1);
  } finally {
    // Cleanup all test users
    for (const userId of testUserIds) {
      await cleanupTestUser(userId);
    }
    await pool.end();
  }
}

runAllTests();
